---
title: "R Notebook"
output: html_notebook
---

```{r}
#install.packages(c("tidyverse", "factoextra", "cluster", "caret"))
```


```{r}
library(tidyverse)
library(factoextra)
library(cluster)
library(caret)
```


```{r}
epidemiology_cancers_nc <- read.csv("data/epidemiologie_cancers_nc.csv", stringsAsFactors = FALSE)
head(df)
```

# cleaning 


## labels

### delete the columns with labels
```{r}
epidemiology_cancers_nc <- epidemiology_cancers_nc %>%
  select(-id_row, -label, -libelle_CIM10)  
```

### encoding categorial variables (into numerical variables : dummy encoding)
```{r}
categorical_vars <- c("SEXE", "CLASSE_AGE", "CODE_CIM10", "indicateur")
col_encoded <- dummyVars(" ~ .", data = epidemiology_cancers_nc[, categorical_vars]) %>%
  predict(newdata = epidemiology_cancers_nc[, categorical_vars]) %>%
  as.data.frame()
```

### combine the encoded columns and the numerical columns
```{r}
numeric_vars <- epidemiology_cancers_nc %>%
  select(-all_of(categorical_vars))
epidemiology_cancers_nc_clean <- cbind(numeric_vars, col_encoded)

head(epidemiology_cancers_nc_clean)
```
## treatment of na

```{r}
# NA
sum(is.na(epidemiology_cancers_nc_clean))
```

### missing values per column
```{r}
na_par_colonne <- colSums(is.na(epidemiology_cancers_nc_clean))

na_epidemiology_cancers_nc <- data.frame(variable = names(na_par_colonne), 
                    na_par_colonne = na_par_colonne,row.names = NULL)

na_epidemiology_cancers_nc
```

### number of rows
```{r}
nrow(epidemiology_cancers_nc_clean)
```

```{r}
epidemiology_cancers_nc_clean <-  epidemiology_cancers_nc_clean %>%
select(-age_median)
```

we delete the rows where frequence is missing
```{r}
epidemiology_cancers_nc_clean <- epidemiology_cancers_nc_clean[complete.cases(epidemiology_cancers_nc_clean), ]

sum(is.na(epidemiology_cancers_nc_clean))
```


# PCA

## normalisation

Now all variables have the same scale.
```{r}
epicancer_scaled <- scale(epidemiology_cancers_nc_clean)

head(epicancer_scaled)
```
## test for pca 
```{r}
# Inf
sum(is.infinite(epicancer_scaled))
```
So we can continue.

## PCA applied
```{r}
pca_result_cancer <- prcomp(epicancer_scaled, center = TRUE, scale. = TRUE)

summary(pca_result_cancer)
```
```{r}
# Calcul de la variance expliquée
variance <- pca_result_cancer$sdev^2
variance_explained <- variance / sum(variance) * 100  # en pourcentage
cum_variance <- cumsum(variance_explained)           # variance cumulée

# Créer un data frame pour ggplot
pca_var_df <- data.frame(
  PC = paste0("PC", 1:length(variance_explained)),
  Variance = variance_explained,
  Cumulative = cum_variance
)

library(ggplot2)

# Barplot de la variance expliquée par chaque PC
ggplot(pca_var_df, aes(x = PC, y = Variance)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Cumulative, group=1), color = "red", size = 1) +
  geom_point(aes(y = Cumulative), color = "red", size = 2) +
  theme_minimal() +
  labs(title = "Proportion de variance expliquée par chaque PC",
       y = "% Variance expliquée",
       x = "Composantes principales") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
oula

```{r}
pca_coords_cancer <- as.data.frame(pca_result_cancer$x[,1:2])  # PC1 et PC2
```

# Clustering

## k-means
```{r}
set.seed(123)
kmeans_result <- kmeans(pca_coords_cancer, centers = 5, nstart = 25)
pca_coords_cancer$cluster <- as.factor(kmeans_result$cluster)

```


```{r}
dist_matrix <- dist(pca_coords_cancer[,1:2])  # distance entre points
hc <- hclust(dist_matrix, method = "ward.D2")
plot(hc, labels = FALSE, main = "Dendrogramme Clustering Hiérarchique")
rect.hclust(hc, k = 5, border = "red")  # optionnel : dessiner les clusters

```


```{r}
library(ggplot2)
ggplot(pca_coords, aes(x=PC1, y=PC2, color=cluster)) +
  geom_point(size=2) +
  theme_minimal() +
  labs(title="Clustering sur PCA (K-Means)")

```

```{r}
cluster_summary <- epidemiology_cancers_nc_clean %>%
  mutate(cluster = kmeans_result$cluster) %>%
  group_by(cluster) %>%
  summarise_all(mean, na.rm = TRUE)

```

